version: '3'

volumes:
  # (Autogenerated) secrets for the ldap container
  secrets-ldap:
  # Crowd server storage
  crowd-data:
  # Bitbucket server storage
  bitbucket-data:

services:

  # Container used to auto-generate secrets (any time the volumes are wiped)
  secrets:
    build: secrets
    security_opt:
      # Disable SElinux for volume mounts (since we're using a host mount)
      - "label=disable"
    volumes:
      - "./ldap:/opt/ldap-init:ro"
      - "secrets-ldap:/secrets/ldap:rw"
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.6"

  ldap:
    image: osixia/openldap:latest
    environment:
      LDAP_ORGANISATION: "Example Inc."
      LDAP_DOMAIN: "example.com"
      LDAP_BASE_DN: "dc=example,dc=com"
      LDAP_SEED_INTERNAL_LDIF_PATH: "/secrets/ldap/ldap-init.ldif"
    security_opt:
      # Disable SElinux for volume mounts (since we're using a host mount)
      - "label=disable"
    volumes:
      - "./ldap:/opt/ldap-init:ro"
      # Load my-secrets.yaml as an environment file
      - "secrets-ldap:/container/environment/01-custom:ro"
      - "secrets-ldap:/secrets/ldap:ro"
    ports:
      - 127.0.0.1:1389:389
      - 127.0.0.1:1636:633
    healthcheck:
      test: ["CMD", "ldapwhoami", "-D", "cn=admin,dc=example,dc=com", "-w", "password", "-H", "ldap://127.0.0.1:389"]
      interval: 30s
      timeout: 5s
      retries: 4
      start_period: 10s
    depends_on:
      secrets:
        condition: service_completed_successfully
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.2"

  ldap-ui:
    image: osixia/phpldapadmin:latest
    ports:
      - 127.0.0.1:8443:443
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap"
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.5"

  crowd:
    image: atlassian/crowd:latest
    environment:
      CROWD_DB_URL: jdbc:postgresql://crowd-db:5432/crowd
      CROWD_DB_USER: postgres
      CROWD_DB_PASSWORD: password
    volumes:
      - crowd-data:/var/atlassian/application-data/crowd
    ports:
      - 127.0.0.1:8095:8095
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.4"

  bitbucket:
    image: atlassian/bitbucket:latest
    volumes:
      - bitbucket-data:/var/atlassian/application-data/bitbucket
    ports:
      - 127.0.0.1:7990:7990
      - 127.0.0.1:7999:7999
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.3"

networks:
  network:
    driver: bridge
    ipam:
      config:
        # NOTE: We set static IPs because Crowd depends upon an IP whitelist.
        #       Otherwise we would have to re-set the whitelist on every restart.
        - subnet: "${ENV_IP_PREFIX}.0/16"
          gateway: "${ENV_IP_PREFIX}.1"
