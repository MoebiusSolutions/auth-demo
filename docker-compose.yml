version: '3'

volumes:
  # (Auto-generated) secrets for...
  # ... the ldap container
  secrets-ldap:
  # ... the keycloak container
  secrets-keycloak:
  # ... the crowd container
  secrets-crowd:
  # ... the bitbucket container
  secrets-bitbucket:
  # ... secrets shared between bitbucket and crowd containers
  secrets-crowd-bitbucket:

  # Crowd server storage
  crowd-data:
  # Bitbucket server storage
  bitbucket-data:

services:

  # Container used to auto-generate secrets (any time the volumes are wiped)
  secrets:
    hostname: secrets.auth-demo.docker
    build: secrets
    security_opt:
      # Disable SElinux for volume mounts (since we're using a host mount)
      - "label=disable"
    volumes:
      - "./ldap:/opt/ldap-init:ro"
      - "secrets-ldap:/secrets/ldap:rw"
      - "secrets-keycloak:/secrets/keycloak:rw"
      - "secrets-crowd:/secrets/crowd:rw"
      - "secrets-bitbucket:/secrets/bitbucket:rw"
      - "secrets-crowd-bitbucket:/secrets/crowd-bitbucket:rw"
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.6"

  ldap:
    hostname: ldap.auth-demo.docker
    image: osixia/openldap:latest
    environment:
      LDAP_ORGANISATION: "Example Inc."
      LDAP_DOMAIN: "example.com"
      LDAP_BASE_DN: "dc=example,dc=com"
      LDAP_SEED_INTERNAL_LDIF_PATH: "/secrets/ldap/ldap-init.ldif"
    security_opt:
      # Disable SElinux for volume mounts (since we're using a host mount)
      - "label=disable"
    volumes:
      - "./ldap:/opt/ldap-init:ro"
      # Load my-secrets.yaml as an environment file
      - "secrets-ldap:/container/environment/01-custom:ro"
      - "secrets-ldap:/secrets/ldap:ro"
    healthcheck:
      # TODO: Fix this vs random password
      test: ["CMD", "ldapwhoami", "-D", "cn=admin,dc=example,dc=com", "-w", "password", "-H", "ldap://127.0.0.1:389"]
      interval: 30s
      timeout: 5s
      retries: 4
      start_period: 10s
    depends_on:
      secrets:
        condition: service_completed_successfully
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.2"

  ldap-ui:
    hostname: ldap-ui.auth-demo.docker
    image: osixia/phpldapadmin:latest
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap"
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.5"

  keycloak:
    hostname: keycloak.auth-demo.docker
    image: jboss/keycloak:latest
    environment:
      KEYCLOAK_USER_FILE: "/secrets/keycloak/admin_username"
      KEYCLOAK_PASSWORD_FILE: "/secrets/keycloak/admin_password"
    volumes:
      - "secrets-keycloak:/secrets/keycloak:ro"
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.7"

  crowd:
    hostname: crowd.auth-demo.docker
    image: atlassian/crowd:latest
    environment:
      CROWD_DB_URL: jdbc:postgresql://crowd-db:5432/crowd
      CROWD_DB_USER: postgres
      CROWD_DB_PASSWORD: password
    volumes:
      - crowd-data:/var/atlassian/application-data/crowd
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.4"

  bitbucket:
    hostname: bitbucket.auth-demo.docker
    image: atlassian/bitbucket:latest
    volumes:
      - bitbucket-data:/var/atlassian/application-data/bitbucket
    networks:
      network:
        ipv4_address: "${ENV_IP_PREFIX}.3"

networks:
  network:
    driver: bridge
    ipam:
      config:
        # NOTE: We set static IPs because Crowd depends upon an IP whitelist.
        #       Otherwise we would have to re-set the whitelist on every restart.
        - subnet: "${ENV_IP_PREFIX}.0/16"
          gateway: "${ENV_IP_PREFIX}.1"
